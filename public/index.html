<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp AI Bot</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WhatsApp AI Bot</h1>
            <div id="status" class="status">Initializing...</div>
        </div>

        <div id="qrcode-container" class="qrcode-container">
            <img id="qrcode" alt="WhatsApp QR Code" style="display: none;">
            <p class="qr-instructions">Scan this QR code with WhatsApp to connect the bot</p>
            <div id="qr-spinner" class="spinner">Loading QR Code...</div>
        </div>

        <div id="chat-container" class="chat-container" style="display: none;">
            <div id="chat-messages" class="chat-messages"></div>
        </div>

        <div class="footer">
            <p>Connection Status: <span id="connection-status">Initializing...</span></p>
        </div>
    </div>

    <script>
        const socket = io();
        const status = document.getElementById('status');
        const qrCode = document.getElementById('qrcode');
        const qrSpinner = document.getElementById('qr-spinner');
        const qrContainer = document.getElementById('qrcode-container');
        const chatContainer = document.getElementById('chat-container');
        const connectionStatus = document.getElementById('connection-status');

        function updateStatus(message, isError = false) {
            status.textContent = message;
            status.className = `status ${isError ? 'error' : ''}`;
        }

        function showQRCode(dataURL) {
            qrSpinner.style.display = 'none';
            qrCode.src = dataURL;
            qrCode.style.display = 'block';
            updateStatus('Scan QR Code with WhatsApp');
        }

        function addChatMessage(from, message, response) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <div class="message-header">${from}</div>
                <div class="message-content">${message}</div>
                <div class="message-response">
                    <strong>AI Response:</strong> ${response}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Socket event handlers
        socket.on('connect', () => {
            connectionStatus.textContent = 'Connected to server';
            qrSpinner.style.display = 'block';
            updateStatus('Waiting for QR Code...');
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'Disconnected from server';
            updateStatus('Connection lost. Reconnecting...', true);
            qrCode.style.display = 'none';
            qrSpinner.style.display = 'block';
            chatContainer.style.display = 'none';
            qrContainer.style.display = 'block';
        });

        socket.on('qr', (qrDataURL) => {
            showQRCode(qrDataURL);
        });

        socket.on('whatsappReady', () => {
            updateStatus('WhatsApp Connected!');
            connectionStatus.textContent = 'WhatsApp Connected';
            qrContainer.style.display = 'none';
            chatContainer.style.display = 'block';
        });

        socket.on('authenticated', () => {
            updateStatus('WhatsApp Authenticated');
            connectionStatus.textContent = 'Authenticated';
        });

        socket.on('authFailed', (message) => {
            updateStatus(message, true);
            connectionStatus.textContent = 'Authentication Failed';
        });

        socket.on('disconnected', (reason) => {
            updateStatus('WhatsApp Disconnected: ' + reason, true);
            connectionStatus.textContent = 'WhatsApp Disconnected';
            qrContainer.style.display = 'block';
            chatContainer.style.display = 'none';
        });

        socket.on('error', (message) => {
            updateStatus(message, true);
        });

        socket.on('messageSent', (data) => {
            addChatMessage(data.from, data.message, data.response);
        });
    </script>
</body>
</html>